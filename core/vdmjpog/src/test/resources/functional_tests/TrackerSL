-- TCErrors: WARNING:5000:30,1 WARNING:5000:42,1 WARNING:5000:83,3 WARNING:5000:113,1 WARNING:5000:129,1 PROOFOBLIGATION: fDE4IHVucGFja2luZ19pbml0YWwsaW52X1BoYXNlKG1rX1BoYXNlKHt9LCBhbGxfbWF0ZXJpYWwsIDUpKQosc3VidHlwZSxudWxsLFVucHJvdmVkfA== PROOFOBLIGATION: fDIwIHNvcnRpbmdfaW5pdGFsLGludl9QaGFzZShta19QaGFzZSh7fSwgYWxsX21hdGVyaWFsLCA2KSkKLHN1YnR5cGUsbnVsbCxVbnByb3ZlZHw= PROOFOBLIGATION: fDIyIGFzc2F5X2luaXRhbCxpbnZfUGhhc2UobWtfUGhhc2Uoe30sIGFsbF9tYXRlcmlhbCwgNSkpCixzdWJ0eXBlLG51bGwsVW5wcm92ZWR8 PROOFOBLIGATION: fDI0IGNvbXBhY3Rpb25faW5pdGFsLGludl9QaGFzZShta19QaGFzZSh7fSwge2dsYXNzLCBtZXRhbCwgcGxhc3RpY30sIDMpKQosc3VidHlwZSxudWxsLFVucHJvdmVkfA== PROOFOBLIGATION: fDI2IHN0b3JhZ2VfaW5pdGFsLGludl9QaGFzZShta19QaGFzZSh7fSwge2dsYXNzLCBtZXRhbCwgcGxhc3RpY30sIDUwKSkKLHN1YnR5cGUsbnVsbCxVbnByb3ZlZHw= PROOFOBLIGATION: fDMyIHBoYXNlc19pbml0YWwsZm9yYWxsIG0xLCBtMiBpbiBzZXQge3tta190b2tlbigiVW5wYWNraW5nIikgfC0+IHVucGFja2luZ19pbml0YWx9LCB7bWtfdG9rZW4oIlNvcnRpbmciKSB8LT4gc29ydGluZ19pbml0YWx9LCB7bWtfdG9rZW4oIkFzc2F5IikgfC0+IGFzc2F5X2luaXRhbH0sIHtta190b2tlbigiQ29tcGFjdGlvbiIpIHwtPiBjb21wYWN0aW9uX2luaXRhbH0sIHtta190b2tlbigiU3RvcmFnZSIpIHwtPiBzdG9yYWdlX2luaXRhbH19ICYKICBmb3JhbGwgZDMgaW4gc2V0IGRvbSBtMSwgZDQgaW4gc2V0IGRvbSBtMiAmCiAgICBkMyA9IGQ0ID0+IG0xKGQzKSA9IG0yKGQ0KQosbWFwIHNlcXVlbmNlIGNvbXBhdGlibGUsbnVsbCxVbnByb3ZlZHw= PROOFOBLIGATION: fDM4IHRyYWNrZXJfaW5pdGFsLGludl9UcmFja2VyKG1rX1RyYWNrZXIoY29uaW5mb19pbml0YWwsIHBoYXNlc19pbml0YWwpKQosc3VidHlwZSxudWxsLFVucHJvdmVkfA== PROOFOBLIGATION: fDg1IEludHJvZHVjZSwoZm9yYWxsIHRyazpUcmFja2VyLCBjaWQ6Q29udGFpbmVySWQsIHF1YW46cmVhbCwgbWF0Ok1hdGVyaWFsICYgKGNpZCBub3QgaW4gc2V0IChkb20gKHRyay5jb250YWluZXJzKSkpID0+CiAgZm9yYWxsIGxkb20xIGluIHNldCBkb20gKHRyay5jb250YWluZXJzKSwgcmRvbTIgaW4gc2V0IGRvbSB7Y2lkIHwtPiBta19Db250YWluZXIocXVhbiwgbWF0KX0gJgogIGxkb20xID0gcmRvbTIgPT4gKHRyay5jb250YWluZXJzKShsZG9tMSkgPSB7Y2lkIHwtPiBta19Db250YWluZXIocXVhbiwgbWF0KX0ocmRvbTIpKQosbWFwIGNvbXBhdGlibGUsbnVsbCxVbnByb3ZlZHw= PROOFOBLIGATION: fDg1IEludHJvZHVjZSwoZm9yYWxsIHRyazpUcmFja2VyLCBjaWQ6Q29udGFpbmVySWQsIHF1YW46cmVhbCwgbWF0Ok1hdGVyaWFsICYgKGNpZCBub3QgaW4gc2V0IChkb20gKHRyay5jb250YWluZXJzKSkpID0+CiAgaW52X1RyYWNrZXIobWtfVHJhY2tlcigoKHRyay5jb250YWluZXJzKSBtdW5pb24ge2NpZCB8LT4gbWtfQ29udGFpbmVyKHF1YW4sIG1hdCl9KSwgKHRyay5waGFzZXMpKSkpCixzdWJ0eXBlLG51bGwsVW5wcm92ZWR8 PROOFOBLIGATION: fDk2IFBlcm1pc3Npb24sKGZvcmFsbCBta19UcmFja2VyKGNvbnRhaW5lcnMsIHBoYXNlcyk6VHJhY2tlciwgY2lkOkNvbnRhaW5lcklkLCBkZXN0OlBoYXNlSWQgJgogICgoY2lkIGluIHNldCAoZG9tIGNvbnRhaW5lcnMpKSA9PgogICAgKChkZXN0IGluIHNldCAoZG9tIHBoYXNlcykpID0+CiAgICAgIGRlc3QgaW4gc2V0IGRvbSBwaGFzZXMpKSkKLG1hcCBhcHBseSxudWxsLFVucHJvdmVkfA== PROOFOBLIGATION: fDk2IFBlcm1pc3Npb24sKGZvcmFsbCBta19UcmFja2VyKGNvbnRhaW5lcnMsIHBoYXNlcyk6VHJhY2tlciwgY2lkOkNvbnRhaW5lcklkLCBkZXN0OlBoYXNlSWQgJgogICgoY2lkIGluIHNldCAoZG9tIGNvbnRhaW5lcnMpKSA9PgogICAgKChkZXN0IGluIHNldCAoZG9tIHBoYXNlcykpID0+CiAgICAgIGRlc3QgaW4gc2V0IGRvbSBwaGFzZXMpKSkKLG1hcCBhcHBseSxudWxsLFVucHJvdmVkfA== PROOFOBLIGATION: fDk3IFBlcm1pc3Npb24sKGZvcmFsbCBta19UcmFja2VyKGNvbnRhaW5lcnMsIHBoYXNlcyk6VHJhY2tlciwgY2lkOkNvbnRhaW5lcklkLCBkZXN0OlBoYXNlSWQgJgogICgoY2lkIGluIHNldCAoZG9tIGNvbnRhaW5lcnMpKSA9PgogICAgKChkZXN0IGluIHNldCAoZG9tIHBoYXNlcykpID0+CiAgICAgICgoKGNhcmQgKHBoYXNlcyhkZXN0KS5jb250ZW50cykpIDwgKHBoYXNlcyhkZXN0KS5jYXBhY2l0eSkpID0+CiAgICAgICAgY2lkIGluIHNldCBkb20gY29udGFpbmVycykpKSkKLG1hcCBhcHBseSxudWxsLFVucHJvdmVkfA== PROOFOBLIGATION: fDk3IFBlcm1pc3Npb24sKGZvcmFsbCBta19UcmFja2VyKGNvbnRhaW5lcnMsIHBoYXNlcyk6VHJhY2tlciwgY2lkOkNvbnRhaW5lcklkLCBkZXN0OlBoYXNlSWQgJgogICgoY2lkIGluIHNldCAoZG9tIGNvbnRhaW5lcnMpKSA9PgogICAgKChkZXN0IGluIHNldCAoZG9tIHBoYXNlcykpID0+CiAgICAgICgoKGNhcmQgKHBoYXNlcyhkZXN0KS5jb250ZW50cykpIDwgKHBoYXNlcyhkZXN0KS5jYXBhY2l0eSkpID0+CiAgICAgICAgZGVzdCBpbiBzZXQgZG9tIHBoYXNlcykpKSkKLG1hcCBhcHBseSxudWxsLFVucHJvdmVkfA== PROOFOBLIGATION: fDEwOSBSZW1vdmUsKGZvcmFsbCBta19UcmFja2VyKGNvbnRhaW5lcnMsIHBoYXNlcyk6VHJhY2tlciwgY2lkOkNvbnRhaW5lcklkLCBzb3VyY2U6UGhhc2VJZCAmCiAgKChzb3VyY2UgaW4gc2V0IChkb20gcGhhc2VzKSkgPT4KICAgIHNvdXJjZSBpbiBzZXQgZG9tIHBoYXNlcykpCixtYXAgYXBwbHksbnVsbCxVbnByb3ZlZHw= PROOFOBLIGATION: fDEwMyBSZW1vdmUsIHBoYSwoZm9yYWxsIG1rX1RyYWNrZXIoY29udGFpbmVycywgcGhhc2VzKTpUcmFja2VyLCBjaWQ6Q29udGFpbmVySWQsIHNvdXJjZTpQaGFzZUlkICYgKChzb3VyY2UgaW4gc2V0IChkb20gcGhhc2VzKSkgYW5kIChjaWQgaW4gc2V0IChwaGFzZXMoc291cmNlKS5jb250ZW50cykpKSA9PgogIHNvdXJjZSBpbiBzZXQgZG9tIHBoYXNlcykKLG1hcCBhcHBseSxudWxsLFVucHJvdmVkfA== PROOFOBLIGATION: fDEwNCBSZW1vdmUsIHBoYSwoZm9yYWxsIG1rX1RyYWNrZXIoY29udGFpbmVycywgcGhhc2VzKTpUcmFja2VyLCBjaWQ6Q29udGFpbmVySWQsIHNvdXJjZTpQaGFzZUlkICYgKChzb3VyY2UgaW4gc2V0IChkb20gcGhhc2VzKSkgYW5kIChjaWQgaW4gc2V0IChwaGFzZXMoc291cmNlKS5jb250ZW50cykpKSA9PgogIHNvdXJjZSBpbiBzZXQgZG9tIHBoYXNlcykKLG1hcCBhcHBseSxudWxsLFVucHJvdmVkfA== PROOFOBLIGATION: fDEwNSBSZW1vdmUsIHBoYSwoZm9yYWxsIG1rX1RyYWNrZXIoY29udGFpbmVycywgcGhhc2VzKTpUcmFja2VyLCBjaWQ6Q29udGFpbmVySWQsIHNvdXJjZTpQaGFzZUlkICYgKChzb3VyY2UgaW4gc2V0IChkb20gcGhhc2VzKSkgYW5kIChjaWQgaW4gc2V0IChwaGFzZXMoc291cmNlKS5jb250ZW50cykpKSA9PgogIHNvdXJjZSBpbiBzZXQgZG9tIHBoYXNlcykKLG1hcCBhcHBseSxudWxsLFVucHJvdmVkfA== PROOFOBLIGATION: fDEwMyBSZW1vdmUsIHBoYSwoZm9yYWxsIG1rX1RyYWNrZXIoY29udGFpbmVycywgcGhhc2VzKTpUcmFja2VyLCBjaWQ6Q29udGFpbmVySWQsIHNvdXJjZTpQaGFzZUlkICYgKChzb3VyY2UgaW4gc2V0IChkb20gcGhhc2VzKSkgYW5kIChjaWQgaW4gc2V0IChwaGFzZXMoc291cmNlKS5jb250ZW50cykpKSA9PgogIGludl9QaGFzZShta19QaGFzZSgoKHBoYXNlcyhzb3VyY2UpLmNvbnRlbnRzKSBcIHtjaWR9KSwgKHBoYXNlcyhzb3VyY2UpLmV4cGVjdGVkX21hdGVyaWFscyksIChwaGFzZXMoc291cmNlKS5jYXBhY2l0eSkpKSkKLHN1YnR5cGUsbnVsbCxVbnByb3ZlZHw= PROOFOBLIGATION: fDEwNyBSZW1vdmUsKGZvcmFsbCBta19UcmFja2VyKGNvbnRhaW5lcnMsIHBoYXNlcyk6VHJhY2tlciwgY2lkOkNvbnRhaW5lcklkLCBzb3VyY2U6UGhhc2VJZCAmICgoc291cmNlIGluIHNldCAoZG9tIHBoYXNlcykpIGFuZCAoY2lkIGluIHNldCAocGhhc2VzKHNvdXJjZSkuY29udGVudHMpKSkgPT4KICAobGV0IHBoYTpQaGFzZSA9IG1rX1BoYXNlKCgocGhhc2VzKHNvdXJjZSkuY29udGVudHMpIFwge2NpZH0pLCAocGhhc2VzKHNvdXJjZSkuZXhwZWN0ZWRfbWF0ZXJpYWxzKSwgKHBoYXNlcyhzb3VyY2UpLmNhcGFjaXR5KSkgaW4KICAgIGludl9UcmFja2VyKG1rX1RyYWNrZXIoY29udGFpbmVycywgKHBoYXNlcyArKyB7c291cmNlIHwtPiBwaGF9KSkpKSkKLHN1YnR5cGUsbnVsbCxVbnByb3ZlZHw= PROOFOBLIGATION: fDExNSBNb3ZlLCBjb250LChmb3JhbGwgdHJrOlRyYWNrZXIsIGNpZDpDb250YWluZXJJZCwgcHRvaWQ6UGhhc2VJZCwgcGZyb21pZDpQaGFzZUlkICYgKFBlcm1pc3Npb24odHJrLCBjaWQsIHB0b2lkKSBhbmQgcHJlX1JlbW92ZSh0cmssIGNpZCwgcGZyb21pZCkpID0+CiAgcHRvaWQgaW4gc2V0IGRvbSAodHJrLnBoYXNlcykpCixtYXAgYXBwbHksbnVsbCxVbnByb3ZlZHw= PROOFOBLIGATION: fDExNyBNb3ZlLCBwaGEsKGZvcmFsbCB0cms6VHJhY2tlciwgY2lkOkNvbnRhaW5lcklkLCBwdG9pZDpQaGFzZUlkLCBwZnJvbWlkOlBoYXNlSWQgJiAoUGVybWlzc2lvbih0cmssIGNpZCwgcHRvaWQpIGFuZCBwcmVfUmVtb3ZlKHRyaywgY2lkLCBwZnJvbWlkKSkgPT4KICAobGV0IGNvbnQ6UGhhc2UgPSAodHJrLnBoYXNlcykocHRvaWQpIGluCiAgICBpbnZfUGhhc2UobWtfUGhhc2UoKChjb250LmNvbnRlbnRzKSB1bmlvbiB7Y2lkfSksIChjb250LmV4cGVjdGVkX21hdGVyaWFscyksIChjb250LmNhcGFjaXR5KSkpKSkKLHN1YnR5cGUsbnVsbCxVbnByb3ZlZHw= PROOFOBLIGATION: fDEyMiBNb3ZlLChmb3JhbGwgdHJrOlRyYWNrZXIsIGNpZDpDb250YWluZXJJZCwgcHRvaWQ6UGhhc2VJZCwgcGZyb21pZDpQaGFzZUlkICYgKFBlcm1pc3Npb24odHJrLCBjaWQsIHB0b2lkKSBhbmQgcHJlX1JlbW92ZSh0cmssIGNpZCwgcGZyb21pZCkpID0+CiAgKGxldCBjb250OlBoYXNlID0gKHRyay5waGFzZXMpKHB0b2lkKSBpbgogICAgKGxldCBwaGE6UGhhc2UgPSBta19QaGFzZSgoKGNvbnQuY29udGVudHMpIHVuaW9uIHtjaWR9KSwgKGNvbnQuZXhwZWN0ZWRfbWF0ZXJpYWxzKSwgKGNvbnQuY2FwYWNpdHkpKSBpbgogICAgICBwcmVfUmVtb3ZlKHRyaywgY2lkLCBwZnJvbWlkKSkpKQosZnVuY3Rpb24gYXBwbHksbnVsbCxVbnByb3ZlZHw= PROOFOBLIGATION: fDEyMSBNb3ZlLChmb3JhbGwgdHJrOlRyYWNrZXIsIGNpZDpDb250YWluZXJJZCwgcHRvaWQ6UGhhc2VJZCwgcGZyb21pZDpQaGFzZUlkICYgKFBlcm1pc3Npb24odHJrLCBjaWQsIHB0b2lkKSBhbmQgcHJlX1JlbW92ZSh0cmssIGNpZCwgcGZyb21pZCkpID0+CiAgKGxldCBjb250OlBoYXNlID0gKHRyay5waGFzZXMpKHB0b2lkKSBpbgogICAgKGxldCBwaGE6UGhhc2UgPSBta19QaGFzZSgoKGNvbnQuY29udGVudHMpIHVuaW9uIHtjaWR9KSwgKGNvbnQuZXhwZWN0ZWRfbWF0ZXJpYWxzKSwgKGNvbnQuY2FwYWNpdHkpKSBpbgogICAgICBpbnZfVHJhY2tlcihta19UcmFja2VyKCh0cmsuY29udGFpbmVycyksICgoUmVtb3ZlKHRyaywgY2lkLCBwZnJvbWlkKS5waGFzZXMpICsrIHtwdG9pZCB8LT4gcGhhfSkpKSkpKQosc3VidHlwZSxudWxsLFVucHJvdmVkfA== PROOFOBLIGATION: fDEzMiBEZWxldGUsKGZvcmFsbCB0a3I6VHJhY2tlciwgY2lkOkNvbnRhaW5lcklkLCBzb3VyY2U6UGhhc2VJZCAmIHByZV9SZW1vdmUodGtyLCBjaWQsIHNvdXJjZSkgPT4KICBwcmVfUmVtb3ZlKHRrciwgY2lkLCBzb3VyY2UpKQosZnVuY3Rpb24gYXBwbHksbnVsbCxVbnByb3ZlZHw= PROOFOBLIGATION: fDEzMSBEZWxldGUsKGZvcmFsbCB0a3I6VHJhY2tlciwgY2lkOkNvbnRhaW5lcklkLCBzb3VyY2U6UGhhc2VJZCAmIHByZV9SZW1vdmUodGtyLCBjaWQsIHNvdXJjZSkgPT4KICBpbnZfVHJhY2tlcihta19UcmFja2VyKCh7Y2lkfSA8LTogKHRrci5jb250YWluZXJzKSksIChSZW1vdmUodGtyLCBjaWQsIHNvdXJjZSkucGhhc2VzKSkpKQosc3VidHlwZSxudWxsLFVucHJvdmVkfA== PROOFOBLIGATION: fDE0NSBQaGFzZXNEaXN0aW5ndWlzaGVkLChmb3JhbGwgcGhhc2VzOlBoYXNlSW5mbyAmCiAgKGZvcmFsbCBwMSwgcDIgaW4gc2V0IChkb20gcGhhc2VzKSAmCiAgICAoKHAxIDw+IHAyKSA9PgogICAgICBwMSBpbiBzZXQgZG9tIHBoYXNlcykpKQosbWFwIGFwcGx5LG51bGwsVW5wcm92ZWR8 PROOFOBLIGATION: fDE0NSBQaGFzZXNEaXN0aW5ndWlzaGVkLChmb3JhbGwgcGhhc2VzOlBoYXNlSW5mbyAmCiAgKGZvcmFsbCBwMSwgcDIgaW4gc2V0IChkb20gcGhhc2VzKSAmCiAgICAoKHAxIDw+IHAyKSA9PgogICAgICBwMiBpbiBzZXQgZG9tIHBoYXNlcykpKQosbWFwIGFwcGx5LG51bGwsVW5wcm92ZWR8 PROOFOBLIGATION: fDE1MiBNYXRlcmlhbFNhZmUsKGZvcmFsbCBjb250YWluZXJzOkNvbnRhaW5lckluZm8sIHBoYXNlczpQaGFzZUluZm8gJgogIChmb3JhbGwgcGggaW4gc2V0IChybmcgcGhhc2VzKSAmCiAgICAoZm9yYWxsIGNpZCBpbiBzZXQgKHBoLmNvbnRlbnRzKSAmCiAgICAgICgoY2lkIGluIHNldCAoZG9tIGNvbnRhaW5lcnMpKSA9PgogICAgICAgIGNpZCBpbiBzZXQgZG9tIGNvbnRhaW5lcnMpKSkpCixtYXAgYXBwbHksbnVsbCxVbnByb3ZlZHw=


--testtracker.vdmsl

values

glass = mk_token("Glass");

liquid = mk_token("liquid");

metal = mk_token("metal");

plastic = mk_token("plastic");

all_material = {glass,liquid,metal,plastic};

unpacking_inital = mk_Phase({},all_material,5);

sorting_inital = mk_Phase({},all_material,6);

assay_inital = mk_Phase({},all_material,5);

compaction_inital = mk_Phase({},{glass,metal,plastic},3);

storage_inital = mk_Phase({},{glass,metal,plastic},50);

coninfo_inital = {|->};

cid1 : ContainerId = mk_token(42);

phases_inital = {mk_token("Unpacking") |-> unpacking_inital,
                 mk_token("Sorting")   |-> sorting_inital,
                 mk_token("Assay")     |-> assay_inital,
                 mk_token("Compaction")|-> compaction_inital,
                 mk_token("Storage")   |-> storage_inital};

tracker_inital = mk_Tracker(coninfo_inital,phases_inital)

functions

SetUp: () -> Tracker
SetUp() ==
  tracker_inital
     


--tracker.vdmsl

types

Tracker :: containers : ContainerInfo
           phases     : PhaseInfo
  inv mk_Tracker(containers,phases) ==
    Consistent(containers,phases) and
    PhasesDistinguished(phases) and
    MaterialSafe(containers,phases);

ContainerInfo = map ContainerId to Container;

PhaseInfo = map PhaseId to Phase;

Container :: fiss_mass : real
             material  : Material;

Phase :: contents          : set of ContainerId
         expected_materials: set of Material
	 capacity          : nat
inv p == card p.contents <= p.capacity and
         p.expected_materials <> {};

ContainerId = token;

PhaseId = token;

Material = token

functions


-- introduce a new container to the plant (map union)

  Introduce : Tracker * ContainerId * real * Material -> Tracker
  Introduce(trk, cid, quan, mat) == 
     mk_Tracker(trk.containers munion 
                {cid |-> mk_Container(quan, mat)},
                trk.phases)
  pre cid not in set dom trk.containers;

-- permission to move (simple Boolean function)

Permission: Tracker * ContainerId * PhaseId  ->  bool
Permission(mk_Tracker(containers, phases), cid, dest) == 
    cid in set dom containers and
    dest in set dom phases and 
    card phases(dest).contents < phases(dest).capacity and
    containers(cid).material in set phases(dest).expected_materials;

-- Remove a container from the contents of a phase

Remove: Tracker * ContainerId * PhaseId -> Tracker
Remove(mk_Tracker(containers, phases), cid, source) ==
  let pha = mk_Phase(phases(source).contents \ {cid},
                     phases(source).expected_materials,
                     phases(source).capacity)
  in
    mk_Tracker(containers, phases ++ {source |-> pha})
pre source in set dom phases and 
    cid in set phases(source).contents;
    
-- move a known container between two phases

Move: Tracker * ContainerId * PhaseId * PhaseId -> Tracker
Move(trk, cid, ptoid, pfromid) ==
  let cont = trk.phases(ptoid)
  in
   let pha = mk_Phase(cont.contents union {cid},
                      cont.expected_materials,
                      cont.capacity)
   in
     mk_Tracker(trk.containers,
                Remove(trk,cid,pfromid).phases ++ 
                {ptoid |-> pha})
pre Permission(trk, cid, ptoid) and 
    pre_Remove(trk,cid,pfromid);

-- delete a container from the plant

Delete: Tracker * ContainerId * PhaseId  ->  Tracker
Delete(tkr, cid, source) ==
   mk_Tracker({cid} <-: tkr.containers,
              Remove(tkr, cid, source).phases)
pre pre_Remove(tkr,cid,source);
    
-- Auxiliary functions defined for inv-Tracker
  Consistent: ContainerInfo * PhaseInfo -> bool
  Consistent(containers, phases) ==
     forall ph in set rng phases & 
        ph.contents subset dom containers;

  PhasesDistinguished: PhaseInfo -> bool
  PhasesDistinguished(phases) ==
     not exists p1, p2 in set dom phases &
        p1 <> p2 and 
        phases(p1).contents inter phases(p2).contents <> {};
	
  MaterialSafe: ContainerInfo * PhaseInfo -> bool
  MaterialSafe(containers, phases) ==                
     forall ph in set rng phases & 
        forall cid in set ph.contents &
	   cid in set dom containers and
           containers(cid).material in set ph.expected_materials