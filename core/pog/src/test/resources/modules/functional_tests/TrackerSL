-- TCErrors: WARNING:5000:30,1 WARNING:5000:42,1 WARNING:5000:83,3 WARNING:5000:113,1 WARNING:5000:129,1 PROOFOBLIGATION: dW5wYWNraW5nX2luaXRhbCwwLGludl9QaGFzZShta19QaGFzZSh7fSwgYWxsX21hdGVyaWFsLCA1KSkKLHN1YnR5cGUsbnVsbCxVbnByb3ZlZCw= PROOFOBLIGATION: c29ydGluZ19pbml0YWwsMCxpbnZfUGhhc2UobWtfUGhhc2Uoe30sIGFsbF9tYXRlcmlhbCwgNikpCixzdWJ0eXBlLG51bGwsVW5wcm92ZWQs PROOFOBLIGATION: YXNzYXlfaW5pdGFsLDAsaW52X1BoYXNlKG1rX1BoYXNlKHt9LCBhbGxfbWF0ZXJpYWwsIDUpKQosc3VidHlwZSxudWxsLFVucHJvdmVkLA== PROOFOBLIGATION: Y29tcGFjdGlvbl9pbml0YWwsMCxpbnZfUGhhc2UobWtfUGhhc2Uoe30sIHtnbGFzcywgbWV0YWwsIHBsYXN0aWN9LCAzKSkKLHN1YnR5cGUsbnVsbCxVbnByb3ZlZCw= PROOFOBLIGATION: c3RvcmFnZV9pbml0YWwsMCxpbnZfUGhhc2UobWtfUGhhc2Uoe30sIHtnbGFzcywgbWV0YWwsIHBsYXN0aWN9LCA1MCkpCixzdWJ0eXBlLG51bGwsVW5wcm92ZWQs PROOFOBLIGATION: cGhhc2VzX2luaXRhbCwwLGZvcmFsbCBtMSwgbTIgaW4gc2V0IHt7bWtfdG9rZW4oIlVucGFja2luZyIpIHwtPiB1bnBhY2tpbmdfaW5pdGFsfSwge21rX3Rva2VuKCJTb3J0aW5nIikgfC0+IHNvcnRpbmdfaW5pdGFsfSwge21rX3Rva2VuKCJBc3NheSIpIHwtPiBhc3NheV9pbml0YWx9LCB7bWtfdG9rZW4oIkNvbXBhY3Rpb24iKSB8LT4gY29tcGFjdGlvbl9pbml0YWx9LCB7bWtfdG9rZW4oIlN0b3JhZ2UiKSB8LT4gc3RvcmFnZV9pbml0YWx9fSAmCiAgZm9yYWxsIGQzIGluIHNldCBkb20gbTEsIGQ0IGluIHNldCBkb20gbTIgJgogICAgZDMgPSBkNCA9PiBtMShkMykgPSBtMihkNCkKLG1hcCBzZXF1ZW5jZSBjb21wYXRpYmxlLG51bGwsVW5wcm92ZWQs PROOFOBLIGATION: dHJhY2tlcl9pbml0YWwsMCxpbnZfVHJhY2tlcihta19UcmFja2VyKGNvbmluZm9faW5pdGFsLCBwaGFzZXNfaW5pdGFsKSkKLHN1YnR5cGUsbnVsbCxVbnByb3ZlZCw= PROOFOBLIGATION: SW50cm9kdWNlLDAsKGZvcmFsbCB0cms6VHJhY2tlciwgY2lkOkNvbnRhaW5lcklkLCBxdWFuOnJlYWwsIG1hdDpNYXRlcmlhbCAmIChjaWQgbm90IGluIHNldCAoZG9tICh0cmsuY29udGFpbmVycykpKSA9PgogIGZvcmFsbCBsZG9tMSBpbiBzZXQgZG9tICh0cmsuY29udGFpbmVycyksIHJkb20yIGluIHNldCBkb20ge2NpZCB8LT4gbWtfQ29udGFpbmVyKHF1YW4sIG1hdCl9ICYKICBsZG9tMSA9IHJkb20yID0+ICh0cmsuY29udGFpbmVycykobGRvbTEpID0ge2NpZCB8LT4gbWtfQ29udGFpbmVyKHF1YW4sIG1hdCl9KHJkb20yKSkKLG1hcCBjb21wYXRpYmxlLG51bGwsVW5wcm92ZWQs PROOFOBLIGATION: SW50cm9kdWNlLDAsKGZvcmFsbCB0cms6VHJhY2tlciwgY2lkOkNvbnRhaW5lcklkLCBxdWFuOnJlYWwsIG1hdDpNYXRlcmlhbCAmIChjaWQgbm90IGluIHNldCAoZG9tICh0cmsuY29udGFpbmVycykpKSA9PgogIGludl9UcmFja2VyKG1rX1RyYWNrZXIoKCh0cmsuY29udGFpbmVycykgbXVuaW9uIHtjaWQgfC0+IG1rX0NvbnRhaW5lcihxdWFuLCBtYXQpfSksICh0cmsucGhhc2VzKSkpKQosc3VidHlwZSxudWxsLFVucHJvdmVkLA== PROOFOBLIGATION: UGVybWlzc2lvbiwwLChmb3JhbGwgbWtfVHJhY2tlcihjb250YWluZXJzLCBwaGFzZXMpOlRyYWNrZXIsIGNpZDpDb250YWluZXJJZCwgZGVzdDpQaGFzZUlkICYKICAoKGNpZCBpbiBzZXQgKGRvbSBjb250YWluZXJzKSkgPT4KICAgICgoZGVzdCBpbiBzZXQgKGRvbSBwaGFzZXMpKSA9PgogICAgICBkZXN0IGluIHNldCBkb20gcGhhc2VzKSkpCixtYXAgYXBwbHksbnVsbCxVbnByb3ZlZCw= PROOFOBLIGATION: UGVybWlzc2lvbiwwLChmb3JhbGwgbWtfVHJhY2tlcihjb250YWluZXJzLCBwaGFzZXMpOlRyYWNrZXIsIGNpZDpDb250YWluZXJJZCwgZGVzdDpQaGFzZUlkICYKICAoKGNpZCBpbiBzZXQgKGRvbSBjb250YWluZXJzKSkgPT4KICAgICgoZGVzdCBpbiBzZXQgKGRvbSBwaGFzZXMpKSA9PgogICAgICBkZXN0IGluIHNldCBkb20gcGhhc2VzKSkpCixtYXAgYXBwbHksbnVsbCxVbnByb3ZlZCw= PROOFOBLIGATION: UGVybWlzc2lvbiwwLChmb3JhbGwgbWtfVHJhY2tlcihjb250YWluZXJzLCBwaGFzZXMpOlRyYWNrZXIsIGNpZDpDb250YWluZXJJZCwgZGVzdDpQaGFzZUlkICYKICAoKGNpZCBpbiBzZXQgKGRvbSBjb250YWluZXJzKSkgPT4KICAgICgoZGVzdCBpbiBzZXQgKGRvbSBwaGFzZXMpKSA9PgogICAgICAoKChjYXJkIChwaGFzZXMoZGVzdCkuY29udGVudHMpKSA8IChwaGFzZXMoZGVzdCkuY2FwYWNpdHkpKSA9PgogICAgICAgIGNpZCBpbiBzZXQgZG9tIGNvbnRhaW5lcnMpKSkpCixtYXAgYXBwbHksbnVsbCxVbnByb3ZlZCw= PROOFOBLIGATION: UGVybWlzc2lvbiwwLChmb3JhbGwgbWtfVHJhY2tlcihjb250YWluZXJzLCBwaGFzZXMpOlRyYWNrZXIsIGNpZDpDb250YWluZXJJZCwgZGVzdDpQaGFzZUlkICYKICAoKGNpZCBpbiBzZXQgKGRvbSBjb250YWluZXJzKSkgPT4KICAgICgoZGVzdCBpbiBzZXQgKGRvbSBwaGFzZXMpKSA9PgogICAgICAoKChjYXJkIChwaGFzZXMoZGVzdCkuY29udGVudHMpKSA8IChwaGFzZXMoZGVzdCkuY2FwYWNpdHkpKSA9PgogICAgICAgIGRlc3QgaW4gc2V0IGRvbSBwaGFzZXMpKSkpCixtYXAgYXBwbHksbnVsbCxVbnByb3ZlZCw= PROOFOBLIGATION: UmVtb3ZlLDAsKGZvcmFsbCBta19UcmFja2VyKGNvbnRhaW5lcnMsIHBoYXNlcyk6VHJhY2tlciwgY2lkOkNvbnRhaW5lcklkLCBzb3VyY2U6UGhhc2VJZCAmCiAgKChzb3VyY2UgaW4gc2V0IChkb20gcGhhc2VzKSkgPT4KICAgIHNvdXJjZSBpbiBzZXQgZG9tIHBoYXNlcykpCixtYXAgYXBwbHksbnVsbCxVbnByb3ZlZCw= PROOFOBLIGATION: UmVtb3ZlLCBwaGEsMCwoZm9yYWxsIG1rX1RyYWNrZXIoY29udGFpbmVycywgcGhhc2VzKTpUcmFja2VyLCBjaWQ6Q29udGFpbmVySWQsIHNvdXJjZTpQaGFzZUlkICYgKChzb3VyY2UgaW4gc2V0IChkb20gcGhhc2VzKSkgYW5kIChjaWQgaW4gc2V0IChwaGFzZXMoc291cmNlKS5jb250ZW50cykpKSA9PgogIHNvdXJjZSBpbiBzZXQgZG9tIHBoYXNlcykKLG1hcCBhcHBseSxudWxsLFVucHJvdmVkLA== PROOFOBLIGATION: UmVtb3ZlLCBwaGEsMCwoZm9yYWxsIG1rX1RyYWNrZXIoY29udGFpbmVycywgcGhhc2VzKTpUcmFja2VyLCBjaWQ6Q29udGFpbmVySWQsIHNvdXJjZTpQaGFzZUlkICYgKChzb3VyY2UgaW4gc2V0IChkb20gcGhhc2VzKSkgYW5kIChjaWQgaW4gc2V0IChwaGFzZXMoc291cmNlKS5jb250ZW50cykpKSA9PgogIHNvdXJjZSBpbiBzZXQgZG9tIHBoYXNlcykKLG1hcCBhcHBseSxudWxsLFVucHJvdmVkLA== PROOFOBLIGATION: UmVtb3ZlLCBwaGEsMCwoZm9yYWxsIG1rX1RyYWNrZXIoY29udGFpbmVycywgcGhhc2VzKTpUcmFja2VyLCBjaWQ6Q29udGFpbmVySWQsIHNvdXJjZTpQaGFzZUlkICYgKChzb3VyY2UgaW4gc2V0IChkb20gcGhhc2VzKSkgYW5kIChjaWQgaW4gc2V0IChwaGFzZXMoc291cmNlKS5jb250ZW50cykpKSA9PgogIHNvdXJjZSBpbiBzZXQgZG9tIHBoYXNlcykKLG1hcCBhcHBseSxudWxsLFVucHJvdmVkLA== PROOFOBLIGATION: UmVtb3ZlLCBwaGEsMCwoZm9yYWxsIG1rX1RyYWNrZXIoY29udGFpbmVycywgcGhhc2VzKTpUcmFja2VyLCBjaWQ6Q29udGFpbmVySWQsIHNvdXJjZTpQaGFzZUlkICYgKChzb3VyY2UgaW4gc2V0IChkb20gcGhhc2VzKSkgYW5kIChjaWQgaW4gc2V0IChwaGFzZXMoc291cmNlKS5jb250ZW50cykpKSA9PgogIGludl9QaGFzZShta19QaGFzZSgoKHBoYXNlcyhzb3VyY2UpLmNvbnRlbnRzKSBcIHtjaWR9KSwgKHBoYXNlcyhzb3VyY2UpLmV4cGVjdGVkX21hdGVyaWFscyksIChwaGFzZXMoc291cmNlKS5jYXBhY2l0eSkpKSkKLHN1YnR5cGUsbnVsbCxVbnByb3ZlZCw= PROOFOBLIGATION: UmVtb3ZlLDAsKGZvcmFsbCBta19UcmFja2VyKGNvbnRhaW5lcnMsIHBoYXNlcyk6VHJhY2tlciwgY2lkOkNvbnRhaW5lcklkLCBzb3VyY2U6UGhhc2VJZCAmICgoc291cmNlIGluIHNldCAoZG9tIHBoYXNlcykpIGFuZCAoY2lkIGluIHNldCAocGhhc2VzKHNvdXJjZSkuY29udGVudHMpKSkgPT4KICAobGV0IHBoYTpQaGFzZSA9IG1rX1BoYXNlKCgocGhhc2VzKHNvdXJjZSkuY29udGVudHMpIFwge2NpZH0pLCAocGhhc2VzKHNvdXJjZSkuZXhwZWN0ZWRfbWF0ZXJpYWxzKSwgKHBoYXNlcyhzb3VyY2UpLmNhcGFjaXR5KSkgaW4KICAgIGludl9UcmFja2VyKG1rX1RyYWNrZXIoY29udGFpbmVycywgKHBoYXNlcyArKyB7c291cmNlIHwtPiBwaGF9KSkpKSkKLHN1YnR5cGUsbnVsbCxVbnByb3ZlZCw= PROOFOBLIGATION: TW92ZSwgY29udCwwLChmb3JhbGwgdHJrOlRyYWNrZXIsIGNpZDpDb250YWluZXJJZCwgcHRvaWQ6UGhhc2VJZCwgcGZyb21pZDpQaGFzZUlkICYgKFBlcm1pc3Npb24odHJrLCBjaWQsIHB0b2lkKSBhbmQgcHJlX1JlbW92ZSh0cmssIGNpZCwgcGZyb21pZCkpID0+CiAgcHRvaWQgaW4gc2V0IGRvbSAodHJrLnBoYXNlcykpCixtYXAgYXBwbHksbnVsbCxVbnByb3ZlZCw= PROOFOBLIGATION: TW92ZSwgcGhhLDAsKGZvcmFsbCB0cms6VHJhY2tlciwgY2lkOkNvbnRhaW5lcklkLCBwdG9pZDpQaGFzZUlkLCBwZnJvbWlkOlBoYXNlSWQgJiAoUGVybWlzc2lvbih0cmssIGNpZCwgcHRvaWQpIGFuZCBwcmVfUmVtb3ZlKHRyaywgY2lkLCBwZnJvbWlkKSkgPT4KICAobGV0IGNvbnQ6UGhhc2UgPSAodHJrLnBoYXNlcykocHRvaWQpIGluCiAgICBpbnZfUGhhc2UobWtfUGhhc2UoKChjb250LmNvbnRlbnRzKSB1bmlvbiB7Y2lkfSksIChjb250LmV4cGVjdGVkX21hdGVyaWFscyksIChjb250LmNhcGFjaXR5KSkpKSkKLHN1YnR5cGUsbnVsbCxVbnByb3ZlZCw= PROOFOBLIGATION: TW92ZSwwLChmb3JhbGwgdHJrOlRyYWNrZXIsIGNpZDpDb250YWluZXJJZCwgcHRvaWQ6UGhhc2VJZCwgcGZyb21pZDpQaGFzZUlkICYgKFBlcm1pc3Npb24odHJrLCBjaWQsIHB0b2lkKSBhbmQgcHJlX1JlbW92ZSh0cmssIGNpZCwgcGZyb21pZCkpID0+CiAgKGxldCBjb250OlBoYXNlID0gKHRyay5waGFzZXMpKHB0b2lkKSBpbgogICAgKGxldCBwaGE6UGhhc2UgPSBta19QaGFzZSgoKGNvbnQuY29udGVudHMpIHVuaW9uIHtjaWR9KSwgKGNvbnQuZXhwZWN0ZWRfbWF0ZXJpYWxzKSwgKGNvbnQuY2FwYWNpdHkpKSBpbgogICAgICBwcmVfUmVtb3ZlKHRyaywgY2lkLCBwZnJvbWlkKSkpKQosZnVuY3Rpb24gYXBwbHksbnVsbCxVbnByb3ZlZCw= PROOFOBLIGATION: TW92ZSwwLChmb3JhbGwgdHJrOlRyYWNrZXIsIGNpZDpDb250YWluZXJJZCwgcHRvaWQ6UGhhc2VJZCwgcGZyb21pZDpQaGFzZUlkICYgKFBlcm1pc3Npb24odHJrLCBjaWQsIHB0b2lkKSBhbmQgcHJlX1JlbW92ZSh0cmssIGNpZCwgcGZyb21pZCkpID0+CiAgKGxldCBjb250OlBoYXNlID0gKHRyay5waGFzZXMpKHB0b2lkKSBpbgogICAgKGxldCBwaGE6UGhhc2UgPSBta19QaGFzZSgoKGNvbnQuY29udGVudHMpIHVuaW9uIHtjaWR9KSwgKGNvbnQuZXhwZWN0ZWRfbWF0ZXJpYWxzKSwgKGNvbnQuY2FwYWNpdHkpKSBpbgogICAgICBpbnZfVHJhY2tlcihta19UcmFja2VyKCh0cmsuY29udGFpbmVycyksICgoUmVtb3ZlKHRyaywgY2lkLCBwZnJvbWlkKS5waGFzZXMpICsrIHtwdG9pZCB8LT4gcGhhfSkpKSkpKQosc3VidHlwZSxudWxsLFVucHJvdmVkLA== PROOFOBLIGATION: RGVsZXRlLDAsKGZvcmFsbCB0a3I6VHJhY2tlciwgY2lkOkNvbnRhaW5lcklkLCBzb3VyY2U6UGhhc2VJZCAmIHByZV9SZW1vdmUodGtyLCBjaWQsIHNvdXJjZSkgPT4KICBwcmVfUmVtb3ZlKHRrciwgY2lkLCBzb3VyY2UpKQosZnVuY3Rpb24gYXBwbHksbnVsbCxVbnByb3ZlZCw= PROOFOBLIGATION: RGVsZXRlLDAsKGZvcmFsbCB0a3I6VHJhY2tlciwgY2lkOkNvbnRhaW5lcklkLCBzb3VyY2U6UGhhc2VJZCAmIHByZV9SZW1vdmUodGtyLCBjaWQsIHNvdXJjZSkgPT4KICBpbnZfVHJhY2tlcihta19UcmFja2VyKCh7Y2lkfSA8LTogKHRrci5jb250YWluZXJzKSksIChSZW1vdmUodGtyLCBjaWQsIHNvdXJjZSkucGhhc2VzKSkpKQosc3VidHlwZSxudWxsLFVucHJvdmVkLA== PROOFOBLIGATION: UGhhc2VzRGlzdGluZ3Vpc2hlZCwwLChmb3JhbGwgcGhhc2VzOlBoYXNlSW5mbyAmCiAgKGZvcmFsbCBwMSwgcDIgaW4gc2V0IChkb20gcGhhc2VzKSAmCiAgICAoKHAxIDw+IHAyKSA9PgogICAgICBwMSBpbiBzZXQgZG9tIHBoYXNlcykpKQosbWFwIGFwcGx5LG51bGwsVW5wcm92ZWQs PROOFOBLIGATION: UGhhc2VzRGlzdGluZ3Vpc2hlZCwwLChmb3JhbGwgcGhhc2VzOlBoYXNlSW5mbyAmCiAgKGZvcmFsbCBwMSwgcDIgaW4gc2V0IChkb20gcGhhc2VzKSAmCiAgICAoKHAxIDw+IHAyKSA9PgogICAgICBwMiBpbiBzZXQgZG9tIHBoYXNlcykpKQosbWFwIGFwcGx5LG51bGwsVW5wcm92ZWQs PROOFOBLIGATION: TWF0ZXJpYWxTYWZlLDAsKGZvcmFsbCBjb250YWluZXJzOkNvbnRhaW5lckluZm8sIHBoYXNlczpQaGFzZUluZm8gJgogIChmb3JhbGwgcGggaW4gc2V0IChybmcgcGhhc2VzKSAmCiAgICAoZm9yYWxsIGNpZCBpbiBzZXQgKHBoLmNvbnRlbnRzKSAmCiAgICAgICgoY2lkIGluIHNldCAoZG9tIGNvbnRhaW5lcnMpKSA9PgogICAgICAgIGNpZCBpbiBzZXQgZG9tIGNvbnRhaW5lcnMpKSkpCixtYXAgYXBwbHksbnVsbCxVbnByb3ZlZCw=


--testtracker.vdmsl

values

glass = mk_token("Glass");

liquid = mk_token("liquid");

metal = mk_token("metal");

plastic = mk_token("plastic");

all_material = {glass,liquid,metal,plastic};

unpacking_inital = mk_Phase({},all_material,5);

sorting_inital = mk_Phase({},all_material,6);

assay_inital = mk_Phase({},all_material,5);

compaction_inital = mk_Phase({},{glass,metal,plastic},3);

storage_inital = mk_Phase({},{glass,metal,plastic},50);

coninfo_inital = {|->};

cid1 : ContainerId = mk_token(42);

phases_inital = {mk_token("Unpacking") |-> unpacking_inital,
                 mk_token("Sorting")   |-> sorting_inital,
                 mk_token("Assay")     |-> assay_inital,
                 mk_token("Compaction")|-> compaction_inital,
                 mk_token("Storage")   |-> storage_inital};

tracker_inital = mk_Tracker(coninfo_inital,phases_inital)

functions

SetUp: () -> Tracker
SetUp() ==
  tracker_inital
     


--tracker.vdmsl

types

Tracker :: containers : ContainerInfo
           phases     : PhaseInfo
  inv mk_Tracker(containers,phases) ==
    Consistent(containers,phases) and
    PhasesDistinguished(phases) and
    MaterialSafe(containers,phases);

ContainerInfo = map ContainerId to Container;

PhaseInfo = map PhaseId to Phase;

Container :: fiss_mass : real
             material  : Material;

Phase :: contents          : set of ContainerId
         expected_materials: set of Material
	 capacity          : nat
inv p == card p.contents <= p.capacity and
         p.expected_materials <> {};

ContainerId = token;

PhaseId = token;

Material = token

functions


-- introduce a new container to the plant (map union)

  Introduce : Tracker * ContainerId * real * Material -> Tracker
  Introduce(trk, cid, quan, mat) == 
     mk_Tracker(trk.containers munion 
                {cid |-> mk_Container(quan, mat)},
                trk.phases)
  pre cid not in set dom trk.containers;

-- permission to move (simple Boolean function)

Permission: Tracker * ContainerId * PhaseId  ->  bool
Permission(mk_Tracker(containers, phases), cid, dest) == 
    cid in set dom containers and
    dest in set dom phases and 
    card phases(dest).contents < phases(dest).capacity and
    containers(cid).material in set phases(dest).expected_materials;

-- Remove a container from the contents of a phase

Remove: Tracker * ContainerId * PhaseId -> Tracker
Remove(mk_Tracker(containers, phases), cid, source) ==
  let pha = mk_Phase(phases(source).contents \ {cid},
                     phases(source).expected_materials,
                     phases(source).capacity)
  in
    mk_Tracker(containers, phases ++ {source |-> pha})
pre source in set dom phases and 
    cid in set phases(source).contents;
    
-- move a known container between two phases

Move: Tracker * ContainerId * PhaseId * PhaseId -> Tracker
Move(trk, cid, ptoid, pfromid) ==
  let cont = trk.phases(ptoid)
  in
   let pha = mk_Phase(cont.contents union {cid},
                      cont.expected_materials,
                      cont.capacity)
   in
     mk_Tracker(trk.containers,
                Remove(trk,cid,pfromid).phases ++ 
                {ptoid |-> pha})
pre Permission(trk, cid, ptoid) and 
    pre_Remove(trk,cid,pfromid);

-- delete a container from the plant

Delete: Tracker * ContainerId * PhaseId  ->  Tracker
Delete(tkr, cid, source) ==
   mk_Tracker({cid} <-: tkr.containers,
              Remove(tkr, cid, source).phases)
pre pre_Remove(tkr,cid,source);
    
-- Auxiliary functions defined for inv-Tracker
  Consistent: ContainerInfo * PhaseInfo -> bool
  Consistent(containers, phases) ==
     forall ph in set rng phases & 
        ph.contents subset dom containers;

  PhasesDistinguished: PhaseInfo -> bool
  PhasesDistinguished(phases) ==
     not exists p1, p2 in set dom phases &
        p1 <> p2 and 
        phases(p1).contents inter phases(p2).contents <> {};
	
  MaterialSafe: ContainerInfo * PhaseInfo -> bool
  MaterialSafe(containers, phases) ==                
     forall ph in set rng phases & 
        forall cid in set ph.contents &
	   cid in set dom containers and
           containers(cid).material in set ph.expected_materials