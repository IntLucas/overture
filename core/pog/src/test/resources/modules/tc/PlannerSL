-- TCErrors: WARNING:5008:65,34 WARNING:5012:74,1 WARNING:5000:95,1 WARNING:5000:124,1 WARNING:5000:140,1 WARNING:5000:152,1 PROOFOBLIGATION: cHAsIHBwfiwgT3MsIE9zfiwgVHMsIFRzfiwgUHMsIFBzfiwgQXMsIEFzfiwgUGFydGlhbF9QbGFuLDAsKGZvcmFsbCBta19QYXJ0aWFsX1BsYW4ocHAsIE9zLCBUcywgUHMsIEFzKTpQYXJ0aWFsX1BsYW4gJgogIG1rX3Rva2VuKCJwaW5pdCIpIGluIHNldCBkb20gT3MpCixtYXAgYXBwbHksbnVsbCxVbnByb3ZlZCw= PROOFOBLIGATION: cHAsIHBwfiwgT3MsIE9zfiwgVHMsIFRzfiwgUHMsIFBzfiwgQXMsIEFzfiwgUGFydGlhbF9QbGFuLDAsKGZvcmFsbCBta19QYXJ0aWFsX1BsYW4ocHAsIE9zLCBUcywgUHMsIEFzKTpQYXJ0aWFsX1BsYW4gJgogICgoT3MobWtfdG9rZW4oInBpbml0IikpID0gbWtfQWN0aW9uKFtta190b2tlbigicGluaXQiKV0sIHt9LCAocHAuSSksIHt9KSkgPT4KICAgIG1rX3Rva2VuKCJnb2FsIikgaW4gc2V0IGRvbSBPcykpCixtYXAgYXBwbHksbnVsbCxVbnByb3ZlZCw= PROOFOBLIGATION: cHAsIHBwfiwgT3MsIE9zfiwgVHMsIFRzfiwgUHMsIFBzfiwgQXMsIEFzfiwgUGFydGlhbF9QbGFuLDAsKGZvcmFsbCBta19QYXJ0aWFsX1BsYW4ocHAsIE9zLCBUcywgUHMsIEFzKTpQYXJ0aWFsX1BsYW4gJgogICgoT3MobWtfdG9rZW4oInBpbml0IikpID0gbWtfQWN0aW9uKFtta190b2tlbigicGluaXQiKV0sIHt9LCAocHAuSSksIHt9KSkgPT4KICAgICgoT3MobWtfdG9rZW4oImdvYWwiKSkgPSBta19BY3Rpb24oW21rX3Rva2VuKCJnb2FsIildLCAocHAuRyksIHt9LCB7fSkpID0+CiAgICAgIG1rX3Rva2VuKCJwaW5pdCIpIGluIHNldCBkb20gT3MpKSkKLG1hcCBhcHBseSxudWxsLFVucHJvdmVkLA== PROOFOBLIGATION: cHAsIHBwfiwgT3MsIE9zfiwgVHMsIFRzfiwgUHMsIFBzfiwgQXMsIEFzfiwgUGFydGlhbF9QbGFuLDAsKGZvcmFsbCBta19QYXJ0aWFsX1BsYW4ocHAsIE9zLCBUcywgUHMsIEFzKTpQYXJ0aWFsX1BsYW4gJgogICgoT3MobWtfdG9rZW4oInBpbml0IikpID0gbWtfQWN0aW9uKFtta190b2tlbigicGluaXQiKV0sIHt9LCAocHAuSSksIHt9KSkgPT4KICAgICgoT3MobWtfdG9rZW4oImdvYWwiKSkgPSBta19BY3Rpb24oW21rX3Rva2VuKCJnb2FsIildLCAocHAuRyksIHt9LCB7fSkpID0+CiAgICAgIG1rX3Rva2VuKCJnb2FsIikgaW4gc2V0IGRvbSBPcykpKQosbWFwIGFwcGx5LG51bGwsVW5wcm92ZWQs PROOFOBLIGATION: cHAsIHBwfiwgT3MsIE9zfiwgVHMsIFRzfiwgUHMsIFBzfiwgQXMsIEFzfiwgUGFydGlhbF9QbGFuLDAsKGZvcmFsbCBta19QYXJ0aWFsX1BsYW4ocHAsIE9zLCBUcywgUHMsIEFzKTpQYXJ0aWFsX1BsYW4gJgogICgoT3MobWtfdG9rZW4oInBpbml0IikpID0gbWtfQWN0aW9uKFtta190b2tlbigicGluaXQiKV0sIHt9LCAocHAuSSksIHt9KSkgPT4KICAgICgoT3MobWtfdG9rZW4oImdvYWwiKSkgPSBta19BY3Rpb24oW21rX3Rva2VuKCJnb2FsIildLCAocHAuRyksIHt9LCB7fSkpID0+CiAgICAgICgoKHJuZyBPcykgc3Vic2V0ICgocHAuQVMpIHVuaW9uIHtPcyhta190b2tlbigicGluaXQiKSksIE9zKG1rX3Rva2VuKCJnb2FsIikpfSkpID0+CiAgICAgICAgKCgoZG9tIE9zKSA9IGdldF9ub2RlcyhUcykpID0+CiAgICAgICAgICAoKChBcyBpbnRlciBQcykgPSB7fSkgPT4KICAgICAgICAgICAgKGZvcmFsbCBBIGluIHNldCAoZG9tIE9zKSAmCiAgICAgICAgICAgICAgQSBpbiBzZXQgZG9tIE9zKSkpKSkpKQosbWFwIGFwcGx5LG51bGwsVW5wcm92ZWQs PROOFOBLIGATION: aW5pdHBvc2V0LDAsaW52X0JvdW5kZWRfUG9zZXQoe21rX0FyYyhta190b2tlbigicGluaXQiKSwgbWtfdG9rZW4oImdvYWwiKSl9KSBhbmQgKAphbmQgaXNfKHtta19BcmMobWtfdG9rZW4oInBpbml0IiksIG1rX3Rva2VuKCJnb2FsIikpfSwgc2V0IG9mIChBcmMpKSkKLHN1YnR5cGUsbnVsbCxVbnByb3ZlZCw= PROOFOBLIGATION: YWRkX25vZGUsMCwoZm9yYWxsIHU6QWN0aW9uX2lkLCBwOkJvdW5kZWRfUG9zZXQgJgogIGludl9Cb3VuZGVkX1Bvc2V0KChwIHVuaW9uIHtta19BcmMobWtfdG9rZW4oInBpbml0IiksIHUpLCBta19BcmModSwgbWtfdG9rZW4oImdvYWwiKSl9KSkgYW5kIChpc18oKHAgdW5pb24ge21rX0FyYyhta190b2tlbigicGluaXQiKSwgdSksIG1rX0FyYyh1LCBta190b2tlbigiZ29hbCIpKX0pLCBzZXQgb2YgKEFyYykpKSkKLHN1YnR5cGUsbnVsbCxVbnByb3ZlZCw= PROOFOBLIGATION: bWFrZV9iZWZvcmUsMCwoZm9yYWxsIHU6QWN0aW9uX2lkLCB2OkFjdGlvbl9pZCwgcDpCb3VuZGVkX1Bvc2V0ICYKICBpbnZfQm91bmRlZF9Qb3NldCgoaWYgKHBvc3NpYmx5X2JlZm9yZSh1LCB2LCBwKSBhbmQgKHt1LCB2fSBzdWJzZXQgZ2V0X25vZGVzKHApKSkKICB0aGVuIChwIHVuaW9uIHtta19BcmModSwgdil9KQogIGVsc2UgcCkpIGFuZCAoaXNfKChpZiAocG9zc2libHlfYmVmb3JlKHUsIHYsIHApIGFuZCAoe3UsIHZ9IHN1YnNldCBnZXRfbm9kZXMocCkpKQogIHRoZW4gKHAgdW5pb24ge21rX0FyYyh1LCB2KX0pCiAgZWxzZSBwKSwgc2V0IG9mIChBcmMpKSkpCixzdWJ0eXBlLG51bGwsVW5wcm92ZWQs PROOFOBLIGATION: bmV3aWQsMCwoZm9yYWxsIGlzYTpzZXQgb2YgKEFjdGlvbl9pZCkgJgogIGV4aXN0cyBpOkFjdGlvbl9pZCAmIHBvc3RfbmV3aWQoaXNhLCBpKSkKLGZ1bmN0aW9uIHNhdGlzZmlhYmlsaXR5LG51bGwsVW5wcm92ZWQs PROOFOBLIGATION: YWNoaWV2ZSwwLChmb3JhbGwgT3M6QWN0aW9uX2luc3RhbmNlcywgVHM6Qm91bmRlZF9Qb3NldCwgQTpBY3Rpb25faWQsIG1rX0dvYWxfaW5zdGFuY2UocCwgTyk6R29hbF9pbnN0YW5jZSAmCiAgKGJlZm9yZShBLCBPLCBUcykgPT4KICAgIEEgaW4gc2V0IGRvbSBPcykpCixtYXAgYXBwbHksbnVsbCxVbnByb3ZlZCw= PROOFOBLIGATION: YWNoaWV2ZSwwLChmb3JhbGwgT3M6QWN0aW9uX2luc3RhbmNlcywgVHM6Qm91bmRlZF9Qb3NldCwgQTpBY3Rpb25faWQsIG1rX0dvYWxfaW5zdGFuY2UocCwgTyk6R29hbF9pbnN0YW5jZSAmCiAgKGJlZm9yZShBLCBPLCBUcykgPT4KICAgICgocCBpbiBzZXQgKE9zKEEpLmFkZCkpID0+CiAgICAgIChmb3JhbGwgQyBpbiBzZXQgKGRvbSBPcykgJgogICAgICAgIChwb3NzaWJseV9iZWZvcmUoQywgTywgVHMpID0+CiAgICAgICAgICAocG9zc2libHlfYmVmb3JlKEEsIEMsIFRzKSA9PgogICAgICAgICAgICBDIGluIHNldCBkb20gT3MpKSkpKSkKLG1hcCBhcHBseSxudWxsLFVucHJvdmVkLA== PROOFOBLIGATION: ZGVjbG9iYmVyLDAsKGZvcmFsbCBPczpBY3Rpb25faW5zdGFuY2VzLCBUczpCb3VuZGVkX1Bvc2V0LCBOZXdBOkFjdGlvbl9pZCwgbWtfR29hbF9pbnN0YW5jZShxLCBDKTpHb2FsX2luc3RhbmNlICYKICAobm90IGJlZm9yZShDLCBOZXdBLCBUcykgPT4KICAgIE5ld0EgaW4gc2V0IGRvbSBPcykpCixtYXAgYXBwbHksbnVsbCxVbnByb3ZlZCw= PROOFOBLIGATION: ZGVjbG9iYmVyLDAsKGZvcmFsbCBPczpBY3Rpb25faW5zdGFuY2VzLCBUczpCb3VuZGVkX1Bvc2V0LCBOZXdBOkFjdGlvbl9pZCwgbWtfR29hbF9pbnN0YW5jZShxLCBDKTpHb2FsX2luc3RhbmNlICYKICAobm90IGJlZm9yZShDLCBOZXdBLCBUcykgPT4KICAgIChub3QgKG5vdCAocSBpbiBzZXQgKE9zKE5ld0EpLmRlbCkpKSA9PgogICAgICAoZm9yYWxsIFcgaW4gc2V0IChkb20gT3MpICYKICAgICAgICAoYmVmb3JlKE5ld0EsIFcsIFRzKSA9PgogICAgICAgICAgKGJlZm9yZShXLCBDLCBUcykgPT4KICAgICAgICAgICAgVyBpbiBzZXQgZG9tIE9zKSkpKSkpCixtYXAgYXBwbHksbnVsbCxVbnByb3ZlZCw= PROOFOBLIGATION: SU5JVCwwLCgocHAgPSBwcGkpID0+CiAgZm9yYWxsIG0xLCBtMiBpbiBzZXQge3tta190b2tlbigicGluaXQiKSB8LT4gbWtfQWN0aW9uKFtta190b2tlbigicGluaXQiKV0sIHt9LCAocHBpLkkpLCB7fSl9LCB7bWtfdG9rZW4oImdvYWwiKSB8LT4gbWtfQWN0aW9uKFtta190b2tlbigiZ29hbCIpXSwgKHBwaS5HKSwge30sIHt9KX19ICYKICAgIGZvcmFsbCBkMyBpbiBzZXQgZG9tIG0xLCBkNCBpbiBzZXQgZG9tIG0yICYKICAgICAgZDMgPSBkNCA9PiBtMShkMykgPSBtMihkNCkpCixtYXAgc2VxdWVuY2UgY29tcGF0aWJsZSxudWxsLFVucHJvdmVkLA== PROOFOBLIGATION: SU5JVCwwLCgocHAgPSBwcGkpIGFuZCAoKE9zID0ge21rX3Rva2VuKCJwaW5pdCIpIHwtPiBta19BY3Rpb24oW21rX3Rva2VuKCJwaW5pdCIpXSwge30sIChwcGkuSSksIHt9KSwgbWtfdG9rZW4oImdvYWwiKSB8LT4gbWtfQWN0aW9uKFtta190b2tlbigiZ29hbCIpXSwgKHBwaS5HKSwge30sIHt9KX0pIGFuZCAoKFRzID0gaW5pdHBvc2V0KCkpIGFuZCAoKFBzID0ge21rX0dvYWxfaW5zdGFuY2UoZywgbWtfdG9rZW4oImdvYWwiKSkgfCBbZyBpbiBzZXQgKHBwaS5HKV19KSBhbmQgKEFzID0ge30pKSkpKQosb3BlcmF0aW9uIHBvc3QgY29uZGl0aW9uLG51bGwsVW5wcm92ZWQs PROOFOBLIGATION: SU5JVCwwLChmb3JhbGwgcHBpOlBsYW5uaW5nX1Byb2JsZW0sIG9sZHN0YXRlOlBhcnRpYWxfUGxhbiAmCiAgcG9zdF9JTklUKHBwaSwgb2xkc3RhdGUsIG5ld3N0YXRlKSkKLG9wZXJhdGlvbiBzYXRpZmlhYmlsaXR5LG51bGwsVW5wcm92ZWQs PROOFOBLIGATION: QUNISUVWRV8xLDAsKGV4aXN0cyBbQSBpbiBzZXQgKGRvbSBPcyldICYgKGFjaGlldmUoT3MsIFRzLCBBLCBnaSkgYW5kIChjb21wbGV0aW9uX29mKFRzLCBUc34pIGFuZCAoKFBzID0gKFBzfiBcIHtnaX0pKSBhbmQgKEFzID0gKEFzfiB1bmlvbiB7Z2l9KSkpKSkpCixvcGVyYXRpb24gcG9zdCBjb25kaXRpb24sbnVsbCxVbnByb3ZlZCw= PROOFOBLIGATION: QUNISUVWRV8xLDAsKGZvcmFsbCBnaTpHb2FsX2luc3RhbmNlLCBvbGRzdGF0ZTpQYXJ0aWFsX1BsYW4gJgogIHByZV9BQ0hJRVZFXzEoZ2ksIG9sZHN0YXRlKSA9PgogIHBvc3RfQUNISUVWRV8xKGdpLCBvbGRzdGF0ZSwgbmV3c3RhdGUpKQosb3BlcmF0aW9uIHNhdGlmaWFiaWxpdHksbnVsbCxVbnByb3ZlZCw= PROOFOBLIGATION: QUNISUVWRV8yLDAsbGV0IE5ld0E6QWN0aW9uX2lkID0gbmV3aWQoKGRvbSBPc34pKSBpbiAoZXhpc3RzIFtBIGluIHNldCAocHAuQVMpXSAmICgoT3MgPSAoT3N+ICsrIHtOZXdBIHwtPiBBfSkpIGFuZCAoYWNoaWV2ZShPcywgVHMsIE5ld0EsIGdpKSBhbmQgKGZvcmFsbCBnaiBpbiBzZXQgQXN+ICYgKGRlY2xvYmJlcihPcywgVHMsIE5ld0EsIGdqKSBhbmQgKGNvbXBsZXRpb25fb2YoVHMsIGFkZF9ub2RlKE5ld0EsIFRzfikpIGFuZCAoKFBzID0gKChQc34gXCB7Z2l9KSB1bmlvbiB7bWtfR29hbF9pbnN0YW5jZShwLCBOZXdBKSB8IFtwIGluIHNldCAoQS5wcmEpXX0pKSBhbmQgKEFzID0gKEFzfiB1bmlvbiB7Z2l9KSkpKSkpKSkpCixvcGVyYXRpb24gcG9zdCBjb25kaXRpb24sbnVsbCxVbnByb3ZlZCw= PROOFOBLIGATION: QUNISUVWRV8yLDAsKGZvcmFsbCBnaTpHb2FsX2luc3RhbmNlLCBvbGRzdGF0ZTpQYXJ0aWFsX1BsYW4gJgogIHByZV9BQ0hJRVZFXzIoZ2ksIG9sZHN0YXRlKSA9PgogIHBvc3RfQUNISUVWRV8yKGdpLCBvbGRzdGF0ZSwgbmV3c3RhdGUpKQosb3BlcmF0aW9uIHNhdGlmaWFiaWxpdHksbnVsbCxVbnByb3ZlZCw=


--planner.vdmsl

\begin{vdm_al}
types

	Literal = seq of token; 
	State = set of Literal;
	Goal = set of Literal;
	Action :: name : Literal
		pra	 : set of Literal
		add	 : set of Literal
		del	 : set of Literal;
	
	Planning_Problem :: AS : set of Action
		          I : State
		          G : Goal

	inv  mk_Planning_Problem ( AS, I, G) ==
	forall l in set G &
		 (l in set I or 
		exists A in set AS & l in set
		 A.add)
	and 		   			                         
	not (G subset I) and
	forall A in set AS & not (exists p : Literal & p in set A.add and
		p in set A.del); 

Action_id = token;
Action_instances = map Action_id to Action;

Arc ::
	  source	: Action_id
          dest    	: Action_id;

Bounded_Poset = set of Arc
inv  p ==
	forall x, y in set get_nodes(p) & 
	not (before(x, y, p) and before(y, x, p)) and
	x <> mk_token("pinit") => before(mk_token("pinit"), x, p) and 
	x <> mk_token("goal") => before(x, mk_token("goal"), p);

 Goal_instance :: 
		   gl : Literal
		   ai : Action_id;

Goal_instances = set of Goal_instance

state Partial_Plan of
	pp: Planning_Problem
	Os: Action_instances
	Ts: Bounded_Poset
	Ps: Goal_instances
	As: Goal_instances
inv  mk_Partial_Plan(pp, Os, Ts, Ps, As)== 
	(Os(mk_token("pinit")) = mk_Action([mk_token("pinit")], { }, pp.I, { })) and
	(Os(mk_token("goal")) = mk_Action([mk_token("goal")], pp.G, { }, { })) and
	rng Os subset pp.AS union {Os(mk_token("pinit")), Os(mk_token("goal"))} and
	dom Os = get_nodes(Ts) and
	As inter Ps = {} and
	forall A in set dom Os & (forall p in set Os(A).pra &  
       		mk_Goal_instance(p, A) in set (Ps union As)) and
	forall gi in set As & exists A in set dom Os & achieve(Os, Ts, A, gi)
end

functions

get_nodes : set of Arc -> set of Action_id
get_nodes(p) ==
	{a.source | a in set p} union {a.dest | a in set p};

before : Action_id * Action_id * set of Arc -> bool 
before(x, z, p) ==
	mk_Arc(x, z) in set p or
	exists y in set get_nodes(p) & before(x, y, p) and before(y, z, p);

possibly_before : Action_id * Action_id * set of Arc -> bool 
possibly_before(x, z, p) ==
	x <> z and not before(z, x, p);

completion_of : Bounded_Poset * Bounded_Poset -> bool 
completion_of(p, q) ==
	(forall x, y in set get_nodes(p) & before(x, y, q) and before(x, y, p));

initposet: () -> Bounded_Poset
initposet() ==
	{mk_Arc(mk_token("pinit"), mk_token("goal"))};

add_node : Action_id * Bounded_Poset -> Bounded_Poset
add_node(u, p) ==
	p union {mk_Arc(mk_token("pinit"), u), mk_Arc(u, mk_token("goal"))};

make_before : Action_id * Action_id * Bounded_Poset -> Bounded_Poset
make_before(u, v, p) ==
	if possibly_before(u, v, p) and {u, v} subset get_nodes(p)
	then p union {mk_Arc(u, v)} else p;


newid(isa : set of Action_id) i: Action_id 
post i not in set isa;

achieve : Action_instances * Bounded_Poset * Action_id * Goal_instance -> bool 
achieve(Os, Ts, A, mk_Goal_instance(p, O)) ==
	before(A, O, Ts) and
	p in set Os(A).add and
	not (exists C in set dom Os & 
	possibly_before(C, O, Ts) and 
	possibly_before(A, C, Ts) and
	p in set Os(C).del); 

declobber:Action_instances * Bounded_Poset * Action_id * Goal_instance -> bool 
declobber(Os, Ts, NewA, mk_Goal_instance(q, C)) ==
	before(C, NewA, Ts) or
 	not(q in set Os(NewA).del) or
	exists W in set dom Os & 
	(before(NewA, W, Ts) and
	before(W, C, Ts) and
	q in set Os(W).add)

operations

INIT (ppi : Planning_Problem)
ext	wr pp : Planning_Problem
	wr Os : Action_instances
	wr Ts : Bounded_Poset
	wr Ps : Goal_instances
	wr As : Goal_instances
post	pp = ppi and
	Os =  {mk_token("pinit") |->  mk_Action([mk_token("pinit")], { }, 
			ppi.I, { }), 
			 mk_token("goal") |->
				 mk_Action([mk_token ("goal")], ppi.G, { }, { })} and
	Ts = initposet( ) and
	Ps = {mk_Goal_instance(g, mk_token("goal")) | g in set ppi.G} and
	As = { };


ACHIEVE_1(gi : Goal_instance)
ext	rd Os : Action_instances
	wr Ts : Bounded_Poset
	wr Ps : Goal_instances
	wr As : Goal_instances
pre	gi in set Ps
post	exists A in set dom Os & achieve(Os, Ts, A, gi) and
	completion_of (Ts, Ts~) and 
	Ps = Ps~ \{gi} and 
	As = As~ union {gi};


ACHIEVE_2(gi: Goal_instance)
ext	rd pp : Planning_Problem
	wr Os : Action_instances
	wr Ts : Bounded_Poset
	wr Ps : Goal_instances
	wr As : Goal_instances
pre	gi in set Ps
post	let NewA = newid(dom Os~) in
	exists A in set pp.AS & Os = Os~ ++ {NewA |-> A} and
	achieve(Os, Ts, NewA, gi) and
	forall gj in set As~ & declobber(Os, Ts, NewA, gj) and
	completion_of(Ts, add_node(NewA, Ts~)) and 
	Ps = (Ps~ \ {gi}) union {mk_Goal_instance(p, NewA) | p in set A.pra} and
	As = As~ union {gi}

\end{vdm_al}