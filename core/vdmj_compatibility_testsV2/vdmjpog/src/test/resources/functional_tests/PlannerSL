-- TCErrors: WARNING:5008:65,34 WARNING:5012:74,1 WARNING:5000:95,1 WARNING:5000:124,1 WARNING:5000:140,1 WARNING:5000:152,1 PROOFOBLIGATION: fDU4OjYgcHAsIHBwfiwgT3MsIE9zfiwgVHMsIFRzfiwgUHMsIFBzfiwgQXMsIEFzfiwgUGFydGlhbF9QbGFuLChmb3JhbGwgbWtfUGFydGlhbF9QbGFuKHBwLCBPcywgVHMsIFBzLCBBcyk6UGFydGlhbF9QbGFuICYKICBta190b2tlbigicGluaXQiKSBpbiBzZXQgZG9tIE9zKQosbWFwIGFwcGx5LG51bGwsVW5wcm92ZWR8 PROOFOBLIGATION: fDU5OjYgcHAsIHBwfiwgT3MsIE9zfiwgVHMsIFRzfiwgUHMsIFBzfiwgQXMsIEFzfiwgUGFydGlhbF9QbGFuLChmb3JhbGwgbWtfUGFydGlhbF9QbGFuKHBwLCBPcywgVHMsIFBzLCBBcyk6UGFydGlhbF9QbGFuICYKICAoKE9zKG1rX3Rva2VuKCJwaW5pdCIpKSA9IG1rX0FjdGlvbihbbWtfdG9rZW4oInBpbml0IildLCB7fSwgKHBwLkkpLCB7fSkpID0+CiAgICBta190b2tlbigiZ29hbCIpIGluIHNldCBkb20gT3MpKQosbWFwIGFwcGx5LG51bGwsVW5wcm92ZWR8 PROOFOBLIGATION: fDYwOjMyIHBwLCBwcH4sIE9zLCBPc34sIFRzLCBUc34sIFBzLCBQc34sIEFzLCBBc34sIFBhcnRpYWxfUGxhbiwoZm9yYWxsIG1rX1BhcnRpYWxfUGxhbihwcCwgT3MsIFRzLCBQcywgQXMpOlBhcnRpYWxfUGxhbiAmCiAgKChPcyhta190b2tlbigicGluaXQiKSkgPSBta19BY3Rpb24oW21rX3Rva2VuKCJwaW5pdCIpXSwge30sIChwcC5JKSwge30pKSA9PgogICAgKChPcyhta190b2tlbigiZ29hbCIpKSA9IG1rX0FjdGlvbihbbWtfdG9rZW4oImdvYWwiKV0sIChwcC5HKSwge30sIHt9KSkgPT4KICAgICAgbWtfdG9rZW4oInBpbml0IikgaW4gc2V0IGRvbSBPcykpKQosbWFwIGFwcGx5LG51bGwsVW5wcm92ZWR8 PROOFOBLIGATION: fDYwOjU1IHBwLCBwcH4sIE9zLCBPc34sIFRzLCBUc34sIFBzLCBQc34sIEFzLCBBc34sIFBhcnRpYWxfUGxhbiwoZm9yYWxsIG1rX1BhcnRpYWxfUGxhbihwcCwgT3MsIFRzLCBQcywgQXMpOlBhcnRpYWxfUGxhbiAmCiAgKChPcyhta190b2tlbigicGluaXQiKSkgPSBta19BY3Rpb24oW21rX3Rva2VuKCJwaW5pdCIpXSwge30sIChwcC5JKSwge30pKSA9PgogICAgKChPcyhta190b2tlbigiZ29hbCIpKSA9IG1rX0FjdGlvbihbbWtfdG9rZW4oImdvYWwiKV0sIChwcC5HKSwge30sIHt9KSkgPT4KICAgICAgbWtfdG9rZW4oImdvYWwiKSBpbiBzZXQgZG9tIE9zKSkpCixtYXAgYXBwbHksbnVsbCxVbnByb3ZlZHw= PROOFOBLIGATION: fDYzOjQ3IHBwLCBwcH4sIE9zLCBPc34sIFRzLCBUc34sIFBzLCBQc34sIEFzLCBBc34sIFBhcnRpYWxfUGxhbiwoZm9yYWxsIG1rX1BhcnRpYWxfUGxhbihwcCwgT3MsIFRzLCBQcywgQXMpOlBhcnRpYWxfUGxhbiAmCiAgKChPcyhta190b2tlbigicGluaXQiKSkgPSBta19BY3Rpb24oW21rX3Rva2VuKCJwaW5pdCIpXSwge30sIChwcC5JKSwge30pKSA9PgogICAgKChPcyhta190b2tlbigiZ29hbCIpKSA9IG1rX0FjdGlvbihbbWtfdG9rZW4oImdvYWwiKV0sIChwcC5HKSwge30sIHt9KSkgPT4KICAgICAgKCgocm5nIE9zKSBzdWJzZXQgKChwcC5BUykgdW5pb24ge09zKG1rX3Rva2VuKCJwaW5pdCIpKSwgT3MobWtfdG9rZW4oImdvYWwiKSl9KSkgPT4KICAgICAgICAoKChkb20gT3MpID0gZ2V0X25vZGVzKFRzKSkgPT4KICAgICAgICAgICgoKEFzIGludGVyIFBzKSA9IHt9KSA9PgogICAgICAgICAgICAoZm9yYWxsIEEgaW4gc2V0IChkb20gT3MpICYKICAgICAgICAgICAgICBBIGluIHNldCBkb20gT3MpKSkpKSkpCixtYXAgYXBwbHksbnVsbCxVbnByb3ZlZHw= PROOFOBLIGATION: fDg3OjEgaW5pdHBvc2V0LGludl9Cb3VuZGVkX1Bvc2V0KHtta19BcmMobWtfdG9rZW4oInBpbml0IiksIG1rX3Rva2VuKCJnb2FsIikpfSkgYW5kICgKYW5kIGlzXyh7bWtfQXJjKG1rX3Rva2VuKCJwaW5pdCIpLCBta190b2tlbigiZ29hbCIpKX0sIHNldCBvZiAoQXJjKSkpCixzdWJ0eXBlLG51bGwsVW5wcm92ZWR8 PROOFOBLIGATION: fDkxOjEgYWRkX25vZGUsKGZvcmFsbCB1OkFjdGlvbl9pZCwgcDpCb3VuZGVkX1Bvc2V0ICYKICBpbnZfQm91bmRlZF9Qb3NldCgocCB1bmlvbiB7bWtfQXJjKG1rX3Rva2VuKCJwaW5pdCIpLCB1KSwgbWtfQXJjKHUsIG1rX3Rva2VuKCJnb2FsIikpfSkpIGFuZCAoaXNfKChwIHVuaW9uIHtta19BcmMobWtfdG9rZW4oInBpbml0IiksIHUpLCBta19BcmModSwgbWtfdG9rZW4oImdvYWwiKSl9KSwgc2V0IG9mIChBcmMpKSkpCixzdWJ0eXBlLG51bGwsVW5wcm92ZWR8 PROOFOBLIGATION: fDk1OjEgbWFrZV9iZWZvcmUsKGZvcmFsbCB1OkFjdGlvbl9pZCwgdjpBY3Rpb25faWQsIHA6Qm91bmRlZF9Qb3NldCAmCiAgaW52X0JvdW5kZWRfUG9zZXQoKGlmIChwb3NzaWJseV9iZWZvcmUodSwgdiwgcCkgYW5kICh7dSwgdn0gc3Vic2V0IGdldF9ub2RlcyhwKSkpCiAgdGhlbiAocCB1bmlvbiB7bWtfQXJjKHUsIHYpfSkKICBlbHNlIHApKSBhbmQgKGlzXygoaWYgKHBvc3NpYmx5X2JlZm9yZSh1LCB2LCBwKSBhbmQgKHt1LCB2fSBzdWJzZXQgZ2V0X25vZGVzKHApKSkKICB0aGVuIChwIHVuaW9uIHtta19BcmModSwgdil9KQogIGVsc2UgcCksIHNldCBvZiAoQXJjKSkpKQosc3VidHlwZSxudWxsLFVucHJvdmVkfA== PROOFOBLIGATION: fDEwMToxIG5ld2lkLChmb3JhbGwgaXNhOnNldCBvZiAoQWN0aW9uX2lkKSAmCiAgZXhpc3RzIGk6QWN0aW9uX2lkICYgcG9zdF9uZXdpZChpc2EsIGkpKQosZnVuY3Rpb24gc2F0aXNmaWFiaWxpdHksbnVsbCxVbnByb3ZlZHw= PROOFOBLIGATION: fDEwNzoxNCBhY2hpZXZlLChmb3JhbGwgT3M6QWN0aW9uX2luc3RhbmNlcywgVHM6Qm91bmRlZF9Qb3NldCwgQTpBY3Rpb25faWQsIG1rX0dvYWxfaW5zdGFuY2UocCwgTyk6R29hbF9pbnN0YW5jZSAmCiAgKGJlZm9yZShBLCBPLCBUcykgPT4KICAgIEEgaW4gc2V0IGRvbSBPcykpCixtYXAgYXBwbHksbnVsbCxVbnByb3ZlZHw= PROOFOBLIGATION: fDExMToxNCBhY2hpZXZlLChmb3JhbGwgT3M6QWN0aW9uX2luc3RhbmNlcywgVHM6Qm91bmRlZF9Qb3NldCwgQTpBY3Rpb25faWQsIG1rX0dvYWxfaW5zdGFuY2UocCwgTyk6R29hbF9pbnN0YW5jZSAmCiAgKGJlZm9yZShBLCBPLCBUcykgPT4KICAgICgocCBpbiBzZXQgKE9zKEEpLmFkZCkpID0+CiAgICAgIChmb3JhbGwgQyBpbiBzZXQgKGRvbSBPcykgJgogICAgICAgIChwb3NzaWJseV9iZWZvcmUoQywgTywgVHMpID0+CiAgICAgICAgICAocG9zc2libHlfYmVmb3JlKEEsIEMsIFRzKSA9PgogICAgICAgICAgICBDIGluIHNldCBkb20gT3MpKSkpKSkKLG1hcCBhcHBseSxudWxsLFVucHJvdmVkfA== PROOFOBLIGATION: fDExNjoxOCBkZWNsb2JiZXIsKGZvcmFsbCBPczpBY3Rpb25faW5zdGFuY2VzLCBUczpCb3VuZGVkX1Bvc2V0LCBOZXdBOkFjdGlvbl9pZCwgbWtfR29hbF9pbnN0YW5jZShxLCBDKTpHb2FsX2luc3RhbmNlICYKICAobm90IGJlZm9yZShDLCBOZXdBLCBUcykgPT4KICAgIE5ld0EgaW4gc2V0IGRvbSBPcykpCixtYXAgYXBwbHksbnVsbCxVbnByb3ZlZHw= PROOFOBLIGATION: fDEyMDoxNCBkZWNsb2JiZXIsKGZvcmFsbCBPczpBY3Rpb25faW5zdGFuY2VzLCBUczpCb3VuZGVkX1Bvc2V0LCBOZXdBOkFjdGlvbl9pZCwgbWtfR29hbF9pbnN0YW5jZShxLCBDKTpHb2FsX2luc3RhbmNlICYKICAobm90IGJlZm9yZShDLCBOZXdBLCBUcykgPT4KICAgIChub3QgKG5vdCAocSBpbiBzZXQgKE9zKE5ld0EpLmRlbCkpKSA9PgogICAgICAoZm9yYWxsIFcgaW4gc2V0IChkb20gT3MpICYKICAgICAgICAoYmVmb3JlKE5ld0EsIFcsIFRzKSA9PgogICAgICAgICAgKGJlZm9yZShXLCBDLCBUcykgPT4KICAgICAgICAgICAgVyBpbiBzZXQgZG9tIE9zKSkpKSkpCixtYXAgYXBwbHksbnVsbCxVbnByb3ZlZHw= PROOFOBLIGATION: fDEzMToxMSBJTklULCgocHAgPSBwcGkpID0+CiAgZm9yYWxsIG0xLCBtMiBpbiBzZXQge3tta190b2tlbigicGluaXQiKSB8LT4gbWtfQWN0aW9uKFtta190b2tlbigicGluaXQiKV0sIHt9LCAocHBpLkkpLCB7fSl9LCB7bWtfdG9rZW4oImdvYWwiKSB8LT4gbWtfQWN0aW9uKFtta190b2tlbigiZ29hbCIpXSwgKHBwaS5HKSwge30sIHt9KX19ICYKICAgIGZvcmFsbCBkMyBpbiBzZXQgZG9tIG0xLCBkNCBpbiBzZXQgZG9tIG0yICYKICAgICAgZDMgPSBkNCA9PiBtMShkMykgPSBtMihkNCkpCixtYXAgc2VxdWVuY2UgY29tcGF0aWJsZSxudWxsLFVucHJvdmVkfA== PROOFOBLIGATION: fDEyNDoxIElOSVQsKChwcCA9IHBwaSkgYW5kICgoT3MgPSB7bWtfdG9rZW4oInBpbml0IikgfC0+IG1rX0FjdGlvbihbbWtfdG9rZW4oInBpbml0IildLCB7fSwgKHBwaS5JKSwge30pLCBta190b2tlbigiZ29hbCIpIHwtPiBta19BY3Rpb24oW21rX3Rva2VuKCJnb2FsIildLCAocHBpLkcpLCB7fSwge30pfSkgYW5kICgoVHMgPSBpbml0cG9zZXQoKSkgYW5kICgoUHMgPSB7bWtfR29hbF9pbnN0YW5jZShnLCBta190b2tlbigiZ29hbCIpKSB8IFtnIGluIHNldCAocHBpLkcpXX0pIGFuZCAoQXMgPSB7fSkpKSkpCixvcGVyYXRpb24gcG9zdCBjb25kaXRpb24sbnVsbCxVbnByb3ZlZHw= PROOFOBLIGATION: fDEyNDoxIElOSVQsKGZvcmFsbCBwcGk6UGxhbm5pbmdfUHJvYmxlbSwgb2xkc3RhdGU6UGFydGlhbF9QbGFuICYKICBwb3N0X0lOSVQocHBpLCBvbGRzdGF0ZSwgbmV3c3RhdGUpKQosb3BlcmF0aW9uIHNhdGlmaWFiaWxpdHksbnVsbCxVbnByb3ZlZHw= PROOFOBLIGATION: fDE0MDoxIEFDSElFVkVfMSwoZXhpc3RzIFtBIGluIHNldCAoZG9tIE9zKV0gJiAoYWNoaWV2ZShPcywgVHMsIEEsIGdpKSBhbmQgKGNvbXBsZXRpb25fb2YoVHMsIFRzfikgYW5kICgoUHMgPSAoUHN+IFwge2dpfSkpIGFuZCAoQXMgPSAoQXN+IHVuaW9uIHtnaX0pKSkpKSkKLG9wZXJhdGlvbiBwb3N0IGNvbmRpdGlvbixudWxsLFVucHJvdmVkfA== PROOFOBLIGATION: fDE0MDoxIEFDSElFVkVfMSwoZm9yYWxsIGdpOkdvYWxfaW5zdGFuY2UsIG9sZHN0YXRlOlBhcnRpYWxfUGxhbiAmCiAgcHJlX0FDSElFVkVfMShnaSwgb2xkc3RhdGUpID0+CiAgcG9zdF9BQ0hJRVZFXzEoZ2ksIG9sZHN0YXRlLCBuZXdzdGF0ZSkpCixvcGVyYXRpb24gc2F0aWZpYWJpbGl0eSxudWxsLFVucHJvdmVkfA== PROOFOBLIGATION: fDE1MjoxIEFDSElFVkVfMixsZXQgTmV3QTpBY3Rpb25faWQgPSBuZXdpZCgoZG9tIE9zfikpIGluIChleGlzdHMgW0EgaW4gc2V0IChwcC5BUyldICYgKChPcyA9IChPc34gKysge05ld0EgfC0+IEF9KSkgYW5kIChhY2hpZXZlKE9zLCBUcywgTmV3QSwgZ2kpIGFuZCAoZm9yYWxsIGdqIGluIHNldCBBc34gJiAoZGVjbG9iYmVyKE9zLCBUcywgTmV3QSwgZ2opIGFuZCAoY29tcGxldGlvbl9vZihUcywgYWRkX25vZGUoTmV3QSwgVHN+KSkgYW5kICgoUHMgPSAoKFBzfiBcIHtnaX0pIHVuaW9uIHtta19Hb2FsX2luc3RhbmNlKHAsIE5ld0EpIHwgW3AgaW4gc2V0IChBLnByYSldfSkpIGFuZCAoQXMgPSAoQXN+IHVuaW9uIHtnaX0pKSkpKSkpKSkKLG9wZXJhdGlvbiBwb3N0IGNvbmRpdGlvbixudWxsLFVucHJvdmVkfA== PROOFOBLIGATION: fDE1MjoxIEFDSElFVkVfMiwoZm9yYWxsIGdpOkdvYWxfaW5zdGFuY2UsIG9sZHN0YXRlOlBhcnRpYWxfUGxhbiAmCiAgcHJlX0FDSElFVkVfMihnaSwgb2xkc3RhdGUpID0+CiAgcG9zdF9BQ0hJRVZFXzIoZ2ksIG9sZHN0YXRlLCBuZXdzdGF0ZSkpCixvcGVyYXRpb24gc2F0aWZpYWJpbGl0eSxudWxsLFVucHJvdmVkfA==


--planner.vdmsl

\begin{vdm_al}
types

	Literal = seq of token; 
	State = set of Literal;
	Goal = set of Literal;
	Action :: name : Literal
		pra	 : set of Literal
		add	 : set of Literal
		del	 : set of Literal;
	
	Planning_Problem :: AS : set of Action
		          I : State
		          G : Goal

	inv  mk_Planning_Problem ( AS, I, G) ==
	forall l in set G &
		 (l in set I or 
		exists A in set AS & l in set
		 A.add)
	and 		   			                         
	not (G subset I) and
	forall A in set AS & not (exists p : Literal & p in set A.add and
		p in set A.del); 

Action_id = token;
Action_instances = map Action_id to Action;

Arc ::
	  source	: Action_id
          dest    	: Action_id;

Bounded_Poset = set of Arc
inv  p ==
	forall x, y in set get_nodes(p) & 
	not (before(x, y, p) and before(y, x, p)) and
	x <> mk_token("pinit") => before(mk_token("pinit"), x, p) and 
	x <> mk_token("goal") => before(x, mk_token("goal"), p);

 Goal_instance :: 
		   gl : Literal
		   ai : Action_id;

Goal_instances = set of Goal_instance

state Partial_Plan of
	pp: Planning_Problem
	Os: Action_instances
	Ts: Bounded_Poset
	Ps: Goal_instances
	As: Goal_instances
inv  mk_Partial_Plan(pp, Os, Ts, Ps, As)== 
	(Os(mk_token("pinit")) = mk_Action([mk_token("pinit")], { }, pp.I, { })) and
	(Os(mk_token("goal")) = mk_Action([mk_token("goal")], pp.G, { }, { })) and
	rng Os subset pp.AS union {Os(mk_token("pinit")), Os(mk_token("goal"))} and
	dom Os = get_nodes(Ts) and
	As inter Ps = {} and
	forall A in set dom Os & (forall p in set Os(A).pra &  
       		mk_Goal_instance(p, A) in set (Ps union As)) and
	forall gi in set As & exists A in set dom Os & achieve(Os, Ts, A, gi)
end

functions

get_nodes : set of Arc -> set of Action_id
get_nodes(p) ==
	{a.source | a in set p} union {a.dest | a in set p};

before : Action_id * Action_id * set of Arc -> bool 
before(x, z, p) ==
	mk_Arc(x, z) in set p or
	exists y in set get_nodes(p) & before(x, y, p) and before(y, z, p);

possibly_before : Action_id * Action_id * set of Arc -> bool 
possibly_before(x, z, p) ==
	x <> z and not before(z, x, p);

completion_of : Bounded_Poset * Bounded_Poset -> bool 
completion_of(p, q) ==
	(forall x, y in set get_nodes(p) & before(x, y, q) and before(x, y, p));

initposet: () -> Bounded_Poset
initposet() ==
	{mk_Arc(mk_token("pinit"), mk_token("goal"))};

add_node : Action_id * Bounded_Poset -> Bounded_Poset
add_node(u, p) ==
	p union {mk_Arc(mk_token("pinit"), u), mk_Arc(u, mk_token("goal"))};

make_before : Action_id * Action_id * Bounded_Poset -> Bounded_Poset
make_before(u, v, p) ==
	if possibly_before(u, v, p) and {u, v} subset get_nodes(p)
	then p union {mk_Arc(u, v)} else p;


newid(isa : set of Action_id) i: Action_id 
post i not in set isa;

achieve : Action_instances * Bounded_Poset * Action_id * Goal_instance -> bool 
achieve(Os, Ts, A, mk_Goal_instance(p, O)) ==
	before(A, O, Ts) and
	p in set Os(A).add and
	not (exists C in set dom Os & 
	possibly_before(C, O, Ts) and 
	possibly_before(A, C, Ts) and
	p in set Os(C).del); 

declobber:Action_instances * Bounded_Poset * Action_id * Goal_instance -> bool 
declobber(Os, Ts, NewA, mk_Goal_instance(q, C)) ==
	before(C, NewA, Ts) or
 	not(q in set Os(NewA).del) or
	exists W in set dom Os & 
	(before(NewA, W, Ts) and
	before(W, C, Ts) and
	q in set Os(W).add)

operations

INIT (ppi : Planning_Problem)
ext	wr pp : Planning_Problem
	wr Os : Action_instances
	wr Ts : Bounded_Poset
	wr Ps : Goal_instances
	wr As : Goal_instances
post	pp = ppi and
	Os =  {mk_token("pinit") |->  mk_Action([mk_token("pinit")], { }, 
			ppi.I, { }), 
			 mk_token("goal") |->
				 mk_Action([mk_token ("goal")], ppi.G, { }, { })} and
	Ts = initposet( ) and
	Ps = {mk_Goal_instance(g, mk_token("goal")) | g in set ppi.G} and
	As = { };


ACHIEVE_1(gi : Goal_instance)
ext	rd Os : Action_instances
	wr Ts : Bounded_Poset
	wr Ps : Goal_instances
	wr As : Goal_instances
pre	gi in set Ps
post	exists A in set dom Os & achieve(Os, Ts, A, gi) and
	completion_of (Ts, Ts~) and 
	Ps = Ps~ \{gi} and 
	As = As~ union {gi};


ACHIEVE_2(gi: Goal_instance)
ext	rd pp : Planning_Problem
	wr Os : Action_instances
	wr Ts : Bounded_Poset
	wr Ps : Goal_instances
	wr As : Goal_instances
pre	gi in set Ps
post	let NewA = newid(dom Os~) in
	exists A in set pp.AS & Os = Os~ ++ {NewA |-> A} and
	achieve(Os, Ts, NewA, gi) and
	forall gj in set As~ & declobber(Os, Ts, NewA, gj) and
	completion_of(Ts, add_node(NewA, Ts~)) and 
	Ps = (Ps~ \ {gi}) union {mk_Goal_instance(p, NewA) | p in set A.pra} and
	As = As~ union {gi}

\end{vdm_al}